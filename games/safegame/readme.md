# 安全隐患排查游戏


手机版单页面游戏，用于普及消防及安全生产知识。
有不同关卡（如消防通道安全、用电安全、消防设施安全等），要求在限定时间内找到隐患，成功后可获得不同的奖励和称号，该游戏寓教于乐，无痛潜意识地让民众掌握基础的消防安全知识。


# 截图

![welcome](./doc/01-welcome.png)
![about](./doc/02-about.png)
![level](./doc/03-level.png)
![game](./doc/04-game.png)
![gametip](./doc/04-game-tip.png)
![gameright](./doc/04-game-right.png)
![info](./doc/05-info.png)
![win](./doc/06-win.png)
![allwin](./doc/07-allwin.png)
[howto](./doc/howto.mp4)


# 游戏流程

首页 -> 关卡选择 -> 开始游戏 -> 限时找到隐患点-> 闯关成功 -> 再玩一次/下一关/查看隐患详情

# 游戏核心功能

- 多个关卡场景（办公室、餐厅等）
- 每个场景有多个安全隐患需要玩家发现
- 限时完成任务
- 点击正确位置显示标记，并显示隐患相关的说明、隐患级别、相关法律条款、建议整改办法等。
- 点击错误位置有声音提示
- 声音效果（背景音乐、点击音效等）


# 关卡设计

- 运行 levelEditor.html，编辑关卡;
- 生成关卡文件 config.json，并将关卡图片更名为 scene.png, 新建目录 leveln, 放入这两个文件。
- 将关卡目录拷贝到 assets/levels/ 目录下；
- 编辑 assets/levels/levels.json，添加刚才添加的关卡文件夹名称。
- 刷新游戏，即可看到新关卡

# 测试和部署


测试

    - 用浏览器打开 indexd.html，查看游戏效果。
    - 打开开发者工具，查看控制台输出。

部署

    - npm run obfuscate，混淆src目录的代码输出到 dist 目录
    - 将index.html, dist目录，assets目录拷贝到服务器
    - 访问 index.html 即可

注意

    - 关卡图片不可太大，在某些机型上加载不了，会导致图片区域变黑
    - 游戏实现了部署为桌面 APP 功能，详见 manifest.json

# 代码结构

```
/assets
    /fonts           # 字体
    /images          # 图片
    /levels          # 关卡
    /sounds          # 音效
/dist                # 编译输出目录
/doc                 # 文档
/lib                 # 库
/src
    /scenes
        GameScene    # 游戏主场景 
        ResultScene  # 游戏结果和得分场景
        DetailScene  # 详情场景（关卡答案或示例）
    /utils
        UIHelper     # UI工具类
        SceneHelper  # 场景工具类
        Buttonhelper # 按钮工具类
        DataManager  # 数据管理类
        GameGuide    # 游戏引导类
        Sharer       # 分享类
```

--------------------------------
Task
--------------------------------
优化
    优化体验：实现图片双指缩放能力
    优化体验，增加LoadScene，加载所有资源（包括字体）
    不知道哪个版本起，无法输出为dist了，报错

计划
    迁移到 TypeScript 版本，无法智能感知实在太痛苦了（工作量很大）

扩展（需要服务器功能）
    通关后可录入手机号，并查看排行榜
    排行榜管理（查看/删除）

--------------------------------
Done
--------------------------------
/优化向导，点击任何地方遮罩均可跳到下一步
/首页增加：应急管理局文字
/优化体验：找到隐患后保持显示错误信息，点击显示隐患详情。
/优化体验：找到所有隐患后，保持几秒再显示游戏成功页面，避免最后一个隐患无法显示
/优化体验：实现面板的滚动条
/优化体验：横屏时居中显示，并约定长宽比9/16
/优化体验：增加关卡锁定解锁逻辑，增加探索欲。
/完善游戏：实现“重新开始”逻辑，清空所有记录，重新开始游戏。
/优化关卡游戏场景：最后10秒开始倒计时声音提示（算了）
/优化 scrollPanel, 实现滑动动画
/优化场景图片
    将场景图片转化为svg，可缩放
    /增加车间吸烟、劳动保护场景
/重构：UIHelper，SceneHelper，所有有js问题的场景。
/恢复 phaser 智能编程提示： npm install phaser，修改 jsconfig.json
/fixbug，混淆后无法加载。。。
/统一levelId参数
/将配置信息今早读取保存到  GameConfig中，简化关卡的参数传递。
/更换首页图片
/游戏界面显示正确示例按钮
/将正确示例提前显示
/修复BUG：浙政钉黑屏
/简化数据传递：
    /找个结构体容纳
        /levelData : {levelId, levelSpots, demoId, demoSpots}
        /showDetail -> showType
    /gameScene 只需要接收一个参数 levelId 就行，根据levelId自动获取demoId、levelConfig、demoConfig
    /ResultScene: {levelData, result, timeUsed, starCount, allLevels}
    /DetailScene: {levelData, showType}
/简化和合并UIHelper
/增加animation
/封装转场动画
/封装messagboxscene.show()
/隐患详情可直接跳到正确示例页面
/修复分享功能
/关于页面加上二维码功能
/实现可拖动内容容器
    /写拖动和mask的示例
    /创建可拖拽容器控件，内部的组件可以上下拖拽（全部改为左上角坐标体系）
    /优化关卡选择场景，把关卡放入滚动区域，关卡太多在有些机型上显示不了。
    /优化关于对话框，提供鸣谢人名列表，需要一个可滚动文本框
/测试兼容性：华为浙政钉打开黑屏：显示“用浏览器打开”, webgl
/配置“正确示例”关卡4、5、6
    /华为手机浏览器：仅2、6关卡可显示图片，有可能是图片太大的原因
    /关卡图片不限制名称，写在config里面（无所谓）
/配置关卡，扩大和优化选区
    /文字都用像素
    /宽度高度都用游戏对象 this.cameras.main.width/height
    /显示"正确示例"
    /修改关卡要求，如：请找出所有灭火器隐患点
/修改网页标题为“安全小侦探”
/分享到朋友圈：生成分享图片，就是截图
/找免费游戏字体
/svg图片预览
/加上关于窗口

/phaser 无智能编程提示
/补完关卡解释
/配置正式关卡*7
/进度条设置圆角
/实现每个场景的加载进度条，避免焦虑
/内置字体避免浏览器不同（首页按钮文字显示不出来）
/用标准scene方式重构
/多跑几次就会出问题（首页无法关闭），结束页面时钟还在跑。
/考虑用Scene重构，使用父子结构元素便于集联删除
/调整游戏结构
    /用 Scene 重构，包含首页Scene、游戏Scene、结果Scene
    /重新开始后，随机选择一个关卡，使用游戏场景 Scene
/实现手机网页全屏，否则很难操作(io无效)
/代码混淆保护
/限制为手机竖屏（未测试）
/更换游戏失败音效 lose-mario.mp3
/找免费游戏字体
/实现PWA模式，可离线使用
/资源加载进度条（主要是背景音乐），算了，缩小了音乐大小
/根据levels.json，随机选择一个关卡
/hazardSpots -> spots
/部署新场景：电动车充电
/成功后显示整改后的隐患
/结束后显示所有隐患及详细解释
/错误点击“嘟嘟“声提示
/因为无法遍历目录，需要弄个总配置文件，或者目录表。
/测试和实现超时失败逻辑
/bgm 循环播放
/优化点击位置，有偏差。用点击位置而不是点位位置
    /背景音乐换个小的
/手机端适配，字体太小了
/加上背景音乐
/隐患点改为红色，提示加大
